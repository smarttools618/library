<!DOCTYPE html>
<html lang="ar" dir="rtl" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>المكتبة</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root {
            --ease-cubic: all 0.35s cubic-bezier(0.4, 0, 0.2, 1);
            --ease-out: all 0.2s ease-out;
        }
        html[data-theme="light"] {
            --primary: #0066ff; --primary-dark: #0040cc;
            --primary-glow: linear-gradient(135deg, #0066ff 0%, #0040cc 100%);
            --background: #f0f2f5; --surface: #ffffff; --surface-secondary: #f8f9fc;
            --text-primary: #1c1e21; --text-secondary: #65676b;
            --border-color: #e0e2e7; --shadow-color: rgba(0, 0, 0, 0.1);
            --glow-color: rgba(0, 102, 255, 0.15);
        }
        html[data-theme="dark"] {
            --primary: #2b8cff; --primary-dark: #0066ff;
            --primary-glow: linear-gradient(135deg, #2b8cff 0%, #0066ff 100%);
            --background: #18191a; --surface: #242526; --surface-secondary: #3a3b3c;
            --text-primary: #e4e6eb; --text-secondary: #b0b3b8;
            --border-color: #3e4042; --shadow-color: rgba(0, 0, 0, 0.4);
            --glow-color: rgba(43, 140, 255, 0.2);
        }
        @keyframes card-fade-in {
            from { opacity: 0; transform: translateY(15px) scale(0.98); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        html { scroll-behavior: smooth; }
        body {
            background: var(--background); color: var(--text-primary);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0; padding-top: 70px; transition: background 0.3s, color 0.3s;
        }
        .page-container { display: flex; }
        .top-bar {
            position: fixed; top: 0; left: 0; right: 0; height: 70px;
            background: var(--surface-transparent, rgba(255, 255, 255, 0.8));
            backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            border-bottom: 1px solid var(--border-color); display: flex; align-items: center;
            justify-content: space-between; padding: 0 24px; z-index: 1100; transition: var(--ease-cubic);
        }
        html[data-theme="dark"] .top-bar { --surface-transparent: rgba(36, 37, 38, 0.8); }
        .logo { display: flex; align-items: center; gap: 12px; color: var(--text-primary); text-decoration: none; }
        .logo-icon {
            background: var(--primary-glow); width: 44px; height: 44px;
            border-radius: 12px; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 12px var(--glow-color); transition: var(--ease-cubic);
        }
        .logo-icon i { font-size: 1.5rem; color: #fff; }
        .logo-text { font-size: 1.5rem; font-weight: 800; }
        .header-controls { display: flex; align-items: center; gap: 16px; }
        .header-btn {
            font-size: 1.3rem; color: var(--text-secondary); background: none; border: none;
            cursor: pointer; padding: 8px; transition: color 0.2s, transform 0.2s;
        }
        .header-btn:hover { color: var(--primary); transform: scale(1.1) rotate(-15deg); }
        .theme-toggle .fa-sun { display: none; }
        html[data-theme="dark"] .theme-toggle .fa-sun { display: inline-block; }
        html[data-theme="dark"] .theme-toggle .fa-moon { display: none; }
        .sidebar {
            width: 250px; background: var(--surface); padding: 24px 0;
            height: calc(100vh - 70px); position: fixed; top: 70px; right: 0;
            overflow-y: auto; border-left: 1px solid var(--border-color);
            transition: var(--ease-cubic); z-index: 1000;
        }
        .filter-form { padding: 0 16px; }
        .filter-group { border: none; padding: 0; margin: 0 0 24px 0; }
        .filter-group legend {
            font-size: 0.9rem; text-transform: uppercase; color: var(--text-secondary);
            padding: 0 8px; margin-bottom: 12px; font-weight: 600;
        }
        .filter-options { display: flex; flex-direction: column; gap: 8px; }
        .filter-options input[type="radio"] { position: absolute; opacity: 0; }
        .filter-options label {
            display: flex; align-items: center; gap: 12px; padding: 10px 16px;
            border-radius: 10px; cursor: pointer; font-weight: 500; transition: var(--ease-out);
        }
        .filter-options label:hover { background: var(--surface-secondary); }
        .filter-options input:checked + label {
            background: var(--primary-glow); color: #fff; font-weight: 700;
            box-shadow: 0 4px 10px var(--glow-color);
        }
        .filter-options .filter-icon { width: 20px; height: 20px; text-align: center; font-size: 1.1em; }
        .filter-options .flag-icon { border-radius: 50%; object-fit: cover; }
        .filter-options input:checked + label .filter-icon { color: #fff !important; }
        .reset-filters-btn {
            display: flex; align-items: center; justify-content: center; gap: 8px;
            width: calc(100% - 32px); margin: 0 16px 24px; padding: 12px;
            border-radius: 10px; background: var(--surface-secondary); color: var(--text-secondary);
            border: 1px solid var(--border-color); font-weight: 600; font-size: 0.95rem;
            cursor: pointer; transition: var(--ease-cubic);
        }
        .reset-filters-btn:hover { background: var(--primary); color: #fff; border-color: var(--primary); }
        .main-content { flex: 1; margin-right: 250px; padding: 32px; transition: margin-right 0.3s, padding 0.3s; }
        .content-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .content-header h1 { font-size: 2rem; margin: 0; transition: opacity 0.3s, transform 0.3s; }
        .video-count-info { font-size: 1rem; font-weight: 500; color: var(--text-secondary); background: var(--surface); padding: 8px 16px; border-radius: 12px; border: 1px solid var(--border-color); }
        /* --- NEW: Search Bar Styles --- */
        .search-container {
            position: relative;
            margin-bottom: 24px;
        }
        .search-input {
            width: 100%;
            padding: 14px 48px 14px 20px;
            font-size: 1rem;
            font-family: inherit;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            background: var(--surface);
            color: var(--text-primary);
            transition: var(--ease-cubic);
            -webkit-appearance: none;
        }
        .search-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--glow-color);
        }
        .search-container .search-icon {
            position: absolute;
            top: 50%;
            right: 18px;
            transform: translateY(-50%);
            color: var(--text-secondary);
            font-size: 1.1rem;
        }
        input[type="search"]::-webkit-search-cancel-button {
             -webkit-appearance: none;
            height: 1.2em;
            width: 1.2em;
            background: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%2365676b'><path d='M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z'/></svg>") center/cover no-repeat;
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.2s;
        }
        input[type="search"]::-webkit-search-cancel-button:hover {
            opacity: 1;
        }
        .selected-filters-summary {
            display: none; margin-bottom: 18px; background: var(--surface-secondary);
            color: var(--text-secondary); border-radius: 10px; padding: 10px 16px;
            font-size: 1rem; font-weight: 500; border: 1px solid var(--border-color); text-align: center;
        }
        @media (max-width: 1024px) { .selected-filters-summary { display: block !important; } }
        .video-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 28px; }
        .video-card {
            background: var(--surface); border-radius: 18px; display: flex; flex-direction: column;
            cursor: pointer; transition: var(--ease-cubic); box-shadow: 0 2px 4px var(--shadow-color);
            border: 1px solid transparent; position: relative;
            animation: card-fade-in 0.5s cubic-bezier(0.4, 0, 0.2, 1) both;
        }
        .video-card:hover, .video-card:focus-visible { 
            transform: translateY(-8px); box-shadow: 0 8px 25px var(--shadow-color); outline: none;
        }
        .video-card:focus-visible { border-color: var(--primary); }
        html[data-theme="dark"] .video-card:hover { border-color: var(--primary); }
        .video-thumbnail { position: relative; width: 100%; aspect-ratio: 16/9; border-radius: 18px 18px 0 0; overflow: hidden; }
        .video-thumbnail img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.4s ease; }
        .video-card:hover .video-thumbnail img, .video-card:focus-visible .video-thumbnail img { transform: scale(1.08); }
        .video-thumbnail-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; display: flex; justify-content: center; align-items: center; background: rgba(0, 0, 0, 0.4); opacity: 0; transition: var(--ease-cubic); }
        .video-card:hover .video-thumbnail-overlay, .video-card:focus-visible .video-thumbnail-overlay { opacity: 1; }
        .play-icon { font-size: 3rem; color: #fff; transform: scale(0.8); transition: var(--ease-cubic); }
        .video-card:hover .play-icon, .video-card:focus-visible .play-icon { transform: scale(1); }
        .video-duration { position: absolute; bottom: 8px; right: 8px; background: rgba(0, 0, 0, 0.75); color: #fff; padding: 2px 8px; border-radius: 6px; font-size: 0.8rem; font-weight: 600; }
        .video-info { padding: 16px; display: flex; gap: 12px; align-items: flex-start; }
        .category-icon { width: 40px; height: 40px; border-radius: 50%; background: var(--primary-glow); color: #fff; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; flex-shrink: 0; }
        .video-details { display: flex; flex-direction: column; min-width: 0; }
        .video-title { font-size: 1.05rem; font-weight: 600; line-height: 1.5; margin: 0 0 6px 0; display: -webkit-box; -webkit-line-clamp: 2; line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; text-overflow: ellipsis; }
        .no-results {
            grid-column: 1 / -1; text-align: center; color: var(--text-secondary); padding: 60px 20px;
            background: var(--surface); border-radius: 18px; border: 2px dashed var(--border-color);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .no-results i { font-size: 3rem; margin-bottom: 16px; color: var(--primary); }
        .no-results p { font-size: 1.2rem; font-weight: 500; margin: 0 0 24px 0; }
        .no-results-reset-btn {
            background: var(--primary-glow); color: #fff; border: none; padding: 10px 20px;
            font-size: 1rem; font-weight: 600; border-radius: 12px; cursor: pointer;
            display: inline-flex; align-items: center; gap: 8px;
            transition: var(--ease-cubic); box-shadow: 0 4px 12px var(--glow-color);
        }
        .no-results-reset-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 16px var(--glow-color); }
        .player-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(8px); z-index: 2000; display: flex; align-items: center; justify-content: center; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; }
        .player-modal.active { opacity: 1; visibility: visible; }
        .player-modal .modal-content { background: var(--surface); border-radius: 18px; box-shadow: 0 15px 50px rgba(0,0,0,0.2); max-width: 900px; width: 90vw; position: relative; transform: scale(0.95); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .player-modal.active .modal-content { transform: scale(1); }
        .player-modal .close-btn { position: absolute; top: -15px; left: -15px; background: var(--surface); border: none; color: var(--text-primary); font-size: 1.2rem; z-index: 2; cursor: pointer; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px var(--shadow-color); transition: transform 0.2s, color 0.2s; }
        .player-modal .close-btn:hover { transform: scale(1.1) rotate(90deg); color: var(--primary); }
        .player-container { width: 100%; aspect-ratio: 16/9; background: #000; border-radius: 18px 18px 0 0; overflow: hidden; }
        .player-container iframe { width: 100%; height: 100%; border: none; }
        #player-title { padding: 16px 20px; font-size: 1.2rem; font-weight: 600; border-top: 1px solid var(--border-color); }
        .help-modal-header { padding: 16px 24px; border-bottom: 1px solid var(--border-color); text-align: center; }
        .help-modal-header h3 { margin: 0; font-size: 1.3rem; color: var(--primary); }
        .help-modal-body { padding: 24px; }
        .help-modal-body p { margin: 0 0 24px 0; text-align: center; color: var(--text-secondary); font-size: 1rem; }
        .contact-info { display: flex; flex-direction: column; gap: 16px; }
        .contact-item {
            display: flex; align-items: center; gap: 16px; padding: 12px 16px; background: var(--surface-secondary);
            border: 1px solid var(--border-color); border-radius: 12px; text-decoration: none; color: var(--text-primary);
            font-weight: 500; transition: var(--ease-cubic);
        }
        .contact-item:hover { background: var(--primary); color: #fff; border-color: var(--primary); transform: translateY(-2px); box-shadow: 0 4px 12px var(--glow-color); }
        .contact-item i { font-size: 1.5rem; width: 28px; text-align: center; color: var(--primary); transition: color 0.3s; }
        .contact-item:hover i { color: #fff; }
        .floating-controls, .filter-modal { display: none; }
        #scroll-trigger { height: 50px; width: 100%; grid-column: 1 / -1; }
        .loader {
            width: 48px; height: 48px; border: 5px solid var(--primary);
            border-bottom-color: transparent; border-radius: 50%;
            display: none; margin: 20px auto; box-sizing: border-box;
            animation: rotation 1s linear infinite;
        }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @media (max-width: 1024px) {
            .logo-text, .sidebar { display: none; }
            .main-content { margin-right: 0; padding: 24px; }
            .floating-controls {
                position: fixed; bottom: 24px; right: 24px;
                z-index: 1050; display: flex; flex-direction: column-reverse; gap: 16px;
            }
            .floating-btn {
                background: var(--primary-glow); color: #fff; border: none; border-radius: 50%;
                width: 56px; height: 56px; display: flex; align-items: center; justify-content: center;
                box-shadow: 0 4px 15px var(--glow-color); cursor: pointer; transition: var(--ease-cubic);
            }
            .floating-icon-container { display: flex; align-items: center; justify-content: center; font-size: 1.5rem; transition: transform 0.3s ease; }
            .floating-icon-container img { width: 28px; height: 28px; border-radius: 50%; object-fit: cover; border: 2px solid var(--surface); }
            .floating-btn:hover { transform: scale(1.05) translateY(-2px); box-shadow: 0 6px 20px var(--glow-color); }
            .floating-btn.is-active {
                background: var(--surface); color: var(--primary);
                border: 2px solid var(--primary); box-shadow: 0 4px 15px var(--shadow-color);
            }
            .floating-btn.reset-btn {
                background: var(--surface); color: var(--text-secondary);
                box-shadow: 0 4px 15px var(--shadow-color); border: 1px solid var(--border-color);
            }
            .floating-btn.reset-btn .floating-icon-container { font-size: 1.3rem; }
            .floating-btn.reset-btn:hover { color: var(--primary); border-color: var(--primary); }
            .filter-modal {
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(8px); z-index: 1200;
                display: flex; align-items: center; justify-content: center;
                opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s;
            }
            .filter-modal.active { opacity: 1; visibility: visible; }
            .filter-modal.active .filter-modal-content { transform: scale(1); }
            .filter-modal-content {
                background: var(--surface); border-radius: 18px; box-shadow: 0 10px 30px var(--shadow-color);
                width: 90vw; max-width: 400px; max-height: 85vh; display: flex; flex-direction: column;
                transform: scale(0.95); transition: transform 0.3s var(--ease-cubic); overflow: hidden;
            }
            .filter-modal-header {
                display: flex; justify-content: space-between; align-items: center; padding: 16px 24px;
                border-bottom: 1px solid var(--border-color); flex-shrink: 0;
            }
            .filter-modal-header h3 { margin: 0; font-size: 1.2rem; }
            .filter-modal .close-btn {
                background: none; border: none; font-size: 1.5rem; cursor: pointer;
                color: var(--text-secondary); padding: 0; line-height: 1; transition: all 0.2s;
            }
            .filter-modal .close-btn:hover { color: var(--primary); transform: rotate(90deg); }
            #filter-modal-options { padding: 8px 16px 24px 16px; overflow-y: auto; }
        }
        @media (max-width: 768px) {
            .main-content { padding: 16px; }
            .video-grid { grid-template-columns: 1fr; gap: 20px; }
            .content-header h1 { font-size: 1.5rem; }
        }
        @media (max-width: 480px) {
            body { padding-top: 56px; padding-bottom: 100px; }
            .top-bar { padding: 0 12px; height: 56px; }
            .floating-controls { bottom: 16px; right: 16px; }
            .floating-btn { width: 52px; height: 52px; font-size: 1.3rem; }
        }
    </style>
</head>
<body>
    <div class="top-bar">
        <a href="index.html" class="logo">
            <span class="logo-icon"><i class="fas fa-book-open"></i></span>
            <span class="logo-text">المكتبة</span>
        </a>
        <div class="header-controls">
            <button class="header-btn" id="help-btn" aria-label="مساعدة و تواصل">
                <i class="fas fa-question-circle"></i>
            </button>
            <button class="header-btn theme-toggle" id="theme-toggle" aria-label="تبديل الوضع">
                <i class="fas fa-moon"></i>
                <i class="fas fa-sun"></i>
            </button>
        </div>
    </div>

    <div class="page-container">
        <aside class="sidebar" id="sidebar">
            <form id="filter-form" class="filter-form">
                <button type="button" class="reset-filters-btn" id="desktop-reset-btn">
                    <i class="fas fa-sync-alt"></i>
                    <span>إعادة تعيين الفلاتر</span>
                </button>
                <fieldset class="filter-group" id="category-filters"></fieldset>
                <fieldset class="filter-group" id="lang-filters"></fieldset>
            </form>
        </aside>
        <main class="main-content">
            <div class="content-header">
                <h1 id="content-title"></h1>
                <div class="video-count-info"><span id="video-count">0</span></div>
            </div>
            
            <!-- NEW: Search Bar -->
            <div class="search-container">
                <input type="search" id="search-input" class="search-input" placeholder="ابحث عن وثائقي...">
                <i class="fas fa-search search-icon"></i>
            </div>
            
            <div class="selected-filters-summary" id="selected-filters-summary" style="display:none;"></div>
            <div class="video-grid" id="video-grid"></div>
            
            <!-- NEW: Scroll Trigger & Loader for Infinite Scroll -->
            <div id="scroll-trigger"></div>
            <div class="loader" id="loader"></div>

        </main>
    </div>

    <div class="floating-controls" id="floating-controls">
        <button id="floating-reset-btn" class="floating-btn reset-btn" aria-label="إعادة تعيين"><span class="floating-icon-container"><i class="fas fa-sync-alt"></i></span></button>
        <button id="floating-lang-btn" class="floating-btn" aria-label="تصفية حسب اللغة"><span class="floating-icon-container"><i class="fas fa-language"></i></span></button>
        <button id="floating-category-btn" class="floating-btn" aria-label="تصفية حسب التصنيف"><span class="floating-icon-container"><i class="fas fa-grip"></i></span></button>
    </div>

    <div class="filter-modal" id="filter-modal">
        <div class="filter-modal-content">
            <div class="filter-modal-header">
                <h3 id="filter-modal-title"></h3>
                <button class="close-btn" id="close-filter-modal-btn" aria-label="إغلاق"><i class="fas fa-times"></i></button>
            </div>
            <div id="filter-modal-options"></div>
        </div>
    </div>

    <div class="player-modal" id="player-modal">
        <div class="modal-content">
            <button class="close-btn" id="close-player-modal" aria-label="إغلاق"><i class="fas fa-times"></i></button>
            <div class="player-container" id="player-container"></div>
            <h3 id="player-title"></h3>
        </div>
    </div>

    <div class="player-modal" id="help-modal">
        <div class="modal-content" style="max-width: 450px;">
            <button class="close-btn" id="close-help-modal" aria-label="إغلاق"><i class="fas fa-times"></i></button>
            <div class="help-modal-header"><h3>تواصل معنا</h3></div>
            <div class="help-modal-body">
                <p>لأية استفسارات أو اقتراحات، يمكنكم التواصل معنا عبر:</p>
                <div class="contact-info">
                    <a href="mailto:smarttools618@gmail.com" class="contact-item">
                        <i class="fas fa-envelope"></i><span>smarttools618@gmail.com</span>
                    </a>
                    <a href="https://www.facebook.com/profile.php?id=61576965144664" target="_blank" rel="noopener noreferrer" class="contact-item">
                        <i class="fab fa-facebook"></i><span>صفحتنا على فيسبوك</span>
                    </a>
                </div>
            </div>
        </div>
    </div>

    <script>
    let allDocumentaries = [];
    // --- Infinite Scroll & Search State ---
    let currentFilteredVideos = [];
    let currentPage = 1;
    const videosPerPage = 12;
    let isLoading = false;

    function fetchDocumentariesAndInit() {
        fetch('videos.json')
            .then(response => {
                if (!response.ok) { throw new Error('Network response was not ok'); }
                return response.json();
            })
            .then(data => {
                allDocumentaries = data;
                document.dispatchEvent(new Event('videosLoaded'));
            })
            .catch(err => {
                console.error('Error loading videos.json:', err);
                document.getElementById('video-grid').innerHTML = `<div class="no-results" style="grid-column: 1 / -1;"><i class="fas fa-exclamation-triangle"></i><p>فشل تحميل البيانات. الرجاء المحاولة مرة أخرى لاحقاً.</p></div>`;
            });
    }

    document.addEventListener('DOMContentLoaded', fetchDocumentariesAndInit);

    document.addEventListener('videosLoaded', function() {
        const elements = {
            htmlEl: document.documentElement,
            themeToggle: document.getElementById('theme-toggle'),
            videoGrid: document.getElementById('video-grid'),
            videoCountEl: document.getElementById('video-count'),
            contentTitle: document.getElementById('content-title'),
            filterForm: document.getElementById('filter-form'),
            categoryFilters: document.getElementById('category-filters'),
            langFilters: document.getElementById('lang-filters'),
            desktopResetBtn: document.getElementById('desktop-reset-btn'),
            floatingCategoryBtn: document.getElementById('floating-category-btn'),
            floatingLangBtn: document.getElementById('floating-lang-btn'),
            floatingResetBtn: document.getElementById('floating-reset-btn'),
            filterModal: document.getElementById('filter-modal'),
            filterModalTitle: document.getElementById('filter-modal-title'),
            filterModalOptions: document.getElementById('filter-modal-options'),
            closeFilterModalBtn: document.getElementById('close-filter-modal-btn'),
            playerModal: document.getElementById('player-modal'),
            playerContainer: document.getElementById('player-container'),
            playerTitle: document.getElementById('player-title'),
            closePlayerBtn: document.getElementById('close-player-modal'),
            selectedFiltersSummary: document.getElementById('selected-filters-summary'),
            helpBtn: document.getElementById('help-btn'),
            helpModal: document.getElementById('help-modal'),
            closeHelpBtn: document.getElementById('close-help-modal'),
            // NEW: Search and Infinite Scroll elements
            searchInput: document.getElementById('search-input'),
            scrollTrigger: document.getElementById('scroll-trigger'),
            loader: document.getElementById('loader'),
        };

        const flags = {
            ar: 'https://cdn.countryflags.com/thumbs/saudi-arabia/flag-round-500.png',
            en: `data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 60 30'%3e%3cclipPath id='a'%3e%3cpath d='M0,0 v30 h60 v-30 z'/%3e%3c/clipPath%3e%3cpath d='M0,0 v30 h60 v-30 z' fill='%2300247d'/%3e%3cpath d='M0,0 L60,30 M60,0 L0,30' stroke='%23fff' stroke-width='6' clip-path='url(%23a)'/%3e%3cpath d='M0,0 L60,30 M60,0 L0,30' stroke='%23cf142b' stroke-width='4' clip-path='url(%23a)'/%3e%3cpath d='M30,0 v30 M0,15 h60' stroke='%23fff' stroke-width='10'/%3e%3cpath d='M30,0 v30 M0,15 h60' stroke='%23cf142b' stroke-width='6'/%3e%3c/svg%3e`,
            fr: `data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 900 600'%3e%3crect width='900' height='600' fill='%23ED2939'/%3e%3crect width='600' height='600' fill='%23fff'/%3e%3crect width='300' height='600' fill='%23002395'/%3e%3c/svg%3e`
        };

        const maps = {
            category: { name: 'التصنيف', options: { all: { name: 'كل التصنيفات', icon: 'fa-grip' }, history: { name: 'التاريخ', icon: 'fa-scroll' }, science: { name: 'العلوم', icon: 'fa-flask-vial' }, technology: { name: 'التقنية', icon: 'fa-satellite-dish' }, geography: { name: 'الجغرافيا', icon: 'fa-earth-africa' } } },
            lang: { name: 'اللغة', options: { all: { name: 'كل اللغات', icon: 'fa-language' }, ar: { name: 'العربية', icon: flags.ar }, en: { name: 'English', icon: flags.en }, fr: { name: 'Français', icon: flags.fr } } }
        };

        let state = { category: 'all', lang: 'all', search: '' };
        
        const renderVideos = (docs) => {
            docs.forEach((doc, index) => {
                const card = document.createElement('div');
                card.className = 'video-card';
                card.dataset.videoId = doc.id;
                card.setAttribute('role', 'button');
                card.setAttribute('tabindex', '0');
                card.setAttribute('aria-label', `تشغيل فيديو: ${doc.title}`);
                // Stagger the animation for newly loaded items
                card.style.animationDelay = `${index * 50}ms`;
                card.innerHTML = `
                    <div class="video-thumbnail">
                        <img src="https://i.ytimg.com/vi/${doc.id}/hqdefault.jpg" alt="${doc.title}" loading="lazy">
                        <div class="video-thumbnail-overlay"><i class="fas fa-play play-icon"></i></div>
                        <span class="video-duration">${doc.duration}</span>
                    </div>
                    <div class="video-info">
                        <div class="category-icon"><i class="fas ${maps.category.options[doc.category].icon}"></i></div>
                        <div class="video-details"><div class="video-title">${doc.title}</div></div>
                    </div>
                `;
                elements.videoGrid.appendChild(card);
            });
        };

        const loadMoreVideos = () => {
            if (isLoading) return;
            isLoading = true;
            elements.loader.style.display = 'block';

            const start = (currentPage - 1) * videosPerPage;
            const end = start + videosPerPage;
            const videosToLoad = currentFilteredVideos.slice(start, end);

            setTimeout(() => { // Simulate network delay for loader visibility
                renderVideos(videosToLoad);
                currentPage++;
                isLoading = false;
                elements.loader.style.display = 'none';
                // Hide loader if no more videos to load
                if (end >= currentFilteredVideos.length) {
                    elements.loader.style.display = 'none';
                }
            }, 300);
        };

        const updateUI = () => {
            const searchTerm = state.search.toLowerCase();
            currentFilteredVideos = allDocumentaries.filter(doc =>
                (state.category === 'all' || doc.category === state.category) &&
                (state.lang === 'all' || doc.lang === state.lang) &&
                (doc.title.toLowerCase().includes(searchTerm))
            );
            
            elements.videoGrid.innerHTML = ''; // Clear existing grid
            currentPage = 1; // Reset page count
            
            if (currentFilteredVideos.length === 0) {
                elements.videoGrid.innerHTML = `
                    <div class="no-results">
                        <i class="fas fa-video-slash"></i>
                        <p>لا توجد نتائج تطابق بحثك.</p>
                        <button class="no-results-reset-btn" id="no-results-reset-btn">
                            <i class="fas fa-sync-alt"></i><span>إعادة تعيين الفلاتر</span>
                        </button>
                    </div>`;
            } else {
                loadMoreVideos();
            }

            elements.videoCountEl.textContent = `${currentFilteredVideos.length} وثائقيات`;
            elements.contentTitle.textContent = generateContentTitle();
            updateSelectedFiltersSummary();
        };
        
        const resetFilters = () => {
            state.category = 'all';
            state.lang = 'all';
            state.search = '';
            elements.searchInput.value = '';
            // Update radio buttons in form
            ['category', 'lang'].forEach(type => {
                const radio = elements.filterForm.querySelector(`input[name="${type}"][value="all"]`);
                if (radio) radio.checked = true;
                updateFloatingButton(type);
            });
            updateUI();
        };

        // --- Intersection Observer for Infinite Scroll ---
        const observer = new IntersectionObserver(entries => {
            if (entries[0].isIntersecting && !isLoading) {
                const totalLoaded = (currentPage - 1) * videosPerPage;
                if (totalLoaded < currentFilteredVideos.length) {
                    loadMoreVideos();
                }
            }
        }, { rootMargin: "0px 0px 200px 0px" });

        observer.observe(elements.scrollTrigger);

        const setupEventListeners = () => {
            elements.searchInput.addEventListener('input', e => {
                state.search = e.target.value;
                updateUI();
            });

            elements.desktopResetBtn.addEventListener('click', resetFilters);
            elements.floatingResetBtn.addEventListener('click', resetFilters);
            elements.videoGrid.addEventListener('click', e => {
                if (e.target.closest('#no-results-reset-btn')) resetFilters();
            });

            // The rest of your event listeners (modals, player, etc.)
            const floatingControls = document.getElementById('floating-controls');
            const openFilterModal = (filterType) => {
                const map = maps[filterType];
                elements.filterModalTitle.textContent = map.name;
                elements.filterModalOptions.innerHTML = renderFilterOptions(filterType, map);
                const currentInput = elements.filterModalOptions.querySelector(`input[value="${state[filterType]}"]`);
                if (currentInput) currentInput.checked = true;
                openModal(elements.filterModal, () => elements.closeFilterModalBtn.focus());
            };
            if (floatingControls) {
                floatingControls.addEventListener('click', function(e) {
                    const btn = e.target.closest('button');
                    if (!btn || btn.id === 'floating-reset-btn') return;
                    e.preventDefault();
                    if (btn.id === 'floating-category-btn') openFilterModal('category');
                    if (btn.id === 'floating-lang-btn') openFilterModal('lang');
                });
            }
            elements.filterForm.addEventListener('change', e => {
                if (state.hasOwnProperty(e.target.name)) {
                    state[e.target.name] = e.target.value;
                    updateUI();
                }
            });
            elements.closeFilterModalBtn.addEventListener('click', () => closeModal(elements.filterModal));
            elements.filterModal.addEventListener('click', e => {
                if (e.target === elements.filterModal) closeModal(elements.filterModal);
            });
            elements.filterModalOptions.addEventListener('change', e => {
                if (state.hasOwnProperty(e.target.name)) {
                    state[e.target.name] = e.target.value;
                    updateUI();
                    closeModal(elements.filterModal);
                }
            });
            const openPlayer = (card) => {
                const doc = allDocumentaries.find(d => d.id === card.dataset.videoId);
                if (doc) {
                    elements.playerContainer.innerHTML = `<iframe src="${doc.embed}?autoplay=1&rel=0" title="${doc.title}" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>`;
                    elements.playerTitle.textContent = doc.title;
                    openModal(elements.playerModal, () => elements.closePlayerBtn.focus());
                }
            };
            elements.videoGrid.addEventListener('click', e => {
                const card = e.target.closest('.video-card');
                if (card) openPlayer(card);
            });
            elements.videoGrid.addEventListener('keydown', e => {
                const card = e.target.closest('.video-card');
                if (card && (e.key === 'Enter' || e.key === ' ')) {
                    e.preventDefault(); openPlayer(card);
                }
            });
            elements.closePlayerBtn.addEventListener('click', () => closeModal(elements.playerModal));
            elements.playerModal.addEventListener('click', e => {
                if (e.target === elements.playerModal) closeModal(elements.playerModal);
            });
            elements.helpBtn.addEventListener('click', () => openModal(elements.helpModal, () => elements.closeHelpBtn.focus()));
            elements.closeHelpBtn.addEventListener('click', () => closeModal(elements.helpModal));
            elements.helpModal.addEventListener('click', e => {
                if (e.target === elements.helpModal) closeModal(elements.helpModal);
            });
            document.addEventListener('keydown', e => {
                if (e.key === 'Escape') {
                    if (elements.playerModal.classList.contains('active')) closeModal(elements.playerModal);
                    if (elements.filterModal.classList.contains('active')) closeModal(elements.filterModal);
                    if (elements.helpModal.classList.contains('active')) closeModal(elements.helpModal);
                }
            });
            window.addEventListener('resize', updateSelectedFiltersSummary);
            elements.themeToggle.addEventListener('click', () => {
                const newTheme = elements.htmlEl.dataset.theme === 'light' ? 'dark' : 'light';
                elements.htmlEl.dataset.theme = newTheme;
                localStorage.setItem('theme', newTheme);
            });
        };

        const init = () => {
            const savedTheme = localStorage.getItem('theme') || 'light';
            elements.htmlEl.dataset.theme = savedTheme;

            elements.categoryFilters.innerHTML = renderSidebarFilterOptions('category', maps.category);
            elements.langFilters.innerHTML = renderSidebarFilterOptions('lang', maps.lang);
            
            setupEventListeners();
            updateUI();
        };
        
        // Helper functions that don't depend on state but are used in init flow
        const renderIcon = (icon, altText) => (typeof icon === 'string' && icon.startsWith('fa-')) ? `<i class="fas ${icon} filter-icon"></i>` : `<img src="${icon}" class="filter-icon flag-icon" alt="${altText} flag">`;
        const renderSidebarFilterOptions = (group, map) => {
            let html = `<legend>${map.name}</legend><div class="filter-options">`;
            for (const [key, value] of Object.entries(map.options)) {
                html += `<input type="radio" id="${group}-${key}" name="${group}" value="${key}" ${key === 'all' ? 'checked' : ''}><label for="${group}-${key}">${renderIcon(value.icon, value.name)} ${value.name}</label>`;
            }
            return html + `</div>`;
        };
        const renderFilterOptions = (group, map) => {
            let html = `<legend>${map.name}</legend><div class="filter-options">`;
            for (const [key, value] of Object.entries(map.options)) {
                html += `<input type="radio" id="${group}-${key}-modal" name="${group}" value="${key}"><label for="${group}-${key}-modal">${renderIcon(value.icon, value.name)} ${value.name}</label>`;
            }
            return html + `</div>`;
        };
        const updateFloatingButton = (type) => {
            let btn = document.getElementById(`floating-${type}-btn`);
            if (!btn) return;
            const iconContainer = btn.querySelector('.floating-icon-container');
            const currentOption = maps[type].options[state[type]];
            const defaultOption = maps[type].options['all'];
            btn.classList.toggle('is-active', state[type] !== 'all');
            const iconToShow = state[type] === 'all' ? defaultOption.icon : currentOption.icon;
            const altText = state[type] === 'all' ? defaultOption.name : currentOption.name;
            if (iconContainer) iconContainer.innerHTML = renderIcon(iconToShow, altText);
        };
        const updateSelectedFiltersSummary = () => {
            if (window.innerWidth > 1024) {
                elements.selectedFiltersSummary.style.display = 'none'; return;
            }
            const cat = maps.category.options[state.category]?.name || '';
            const lang = maps.lang.options[state.lang]?.name || '';
            let summaryParts = [];
            if (state.category !== 'all') summaryParts.push(`التصنيف: <b>${cat}</b>`);
            if (state.lang !== 'all') summaryParts.push(`اللغة: <b>${lang}</b>`);
            if (summaryParts.length === 0) {
                elements.selectedFiltersSummary.innerHTML = 'عرض كل التصنيفات واللغات';
            } else {
                elements.selectedFiltersSummary.innerHTML = summaryParts.join(' | ');
            }
            elements.selectedFiltersSummary.style.display = 'block';
        };
        const generateContentTitle = () => {
            const catName = maps.category.options[state.category].name;
            const langName = maps.lang.options[state.lang].name;
            if (state.category === 'all' && state.lang === 'all') return 'كل الوثائقيات';
            if (state.category !== 'all' && state.lang === 'all') return catName;
            if (state.category === 'all' && state.lang !== 'all') return `وثائقيات (${langName})`;
            return `${catName} (${langName})`;
        };
        const openModal = (modalElement, onOpen) => {
            modalElement.classList.add('active'); document.body.style.overflow = 'hidden'; if (onOpen) onOpen();
        };
        const closeModal = (modalElement) => {
            modalElement.classList.remove('active'); document.body.style.overflow = '';
        };

        init();
    });
    </script>
</body>
</html>